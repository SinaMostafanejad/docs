---
title: Use federated identities with SDK
menu:
  default:
    identifier: ja-guides-hosting-iam-authentication-identity_federation
    parent: authentication
---

W&B SDK を通じて、組織の認証情報を使用してサインインするために、ID連携を使用します。W&B の組織管理者が組織の SSO を設定している場合、すでに組織の認証情報を使用して W&B アプリの UI にサインインしているはずです。その意味で、ID連携は W&B SDK の SSO のようなものですが、JSON Web Tokens (JWT) を直接使用します。ID連携は、 API キーの代替として使用できます。

[RFC 7523](https://datatracker.ietf.org/doc/html/rfc7523) は、SDK との ID連携の基礎を形成します。

{{% alert %}}
ID連携は、すべてのプラットフォームタイプ (SaaS Cloud、専用クラウド、および自己管理インスタンス) の `Enterprise` プランで `Preview` として利用できます。ご不明な点がございましたら、W&B チームにお問い合わせください。
{{% /alert %}}

{{% alert %}}
このドキュメントでは、`ID プロバイダー` と `JWT 発行者` という用語は同じ意味で使用されます。どちらも、この機能のコンテキストでは同じものを指します。
{{% /alert %}}

## JWT 発行者の設定

最初の手順として、組織管理者は W&B 組織とパブリックにアクセス可能な JWT 発行者間の連携を設定する必要があります。

* 組織 ダッシュボード の **Settings** タブに移動します。
* **Authentication** オプションで、`Set up JWT Issuer` を押します。
* テキストボックスに JWT 発行者の URL を追加し、`Create` を押します。

W&B は、`${ISSUER_URL}/.well-known/oidc-configuration` パスで OIDC ディスカバリドキュメントを自動的に検索し、ディスカバリドキュメント内の関連する URL で JSON Web Key Set (JWKS) を見つけようとします。JWKS は、JWT のリアルタイム検証に使用され、関連する ID プロバイダーによって発行されたことを確認します。

## JWT を使用して W&B にアクセスする

JWT 発行者が W&B 組織に設定されると、 ユーザー はその ID プロバイダーによって発行された JWT を使用して、関連する W&B プロジェクト へのアクセスを開始できます。JWT を使用するメカニズムは次のとおりです。

* 組織で利用可能なメカニズムのいずれかを使用して、ID プロバイダー にサインインする必要があります。一部のプロバイダーは、API または SDK を使用して自動化された方法でアクセスできますが、関連する UI を使用してのみアクセスできるプロバイダーもあります。詳細については、W&B 組織の管理者または JWT 発行者の所有者にお問い合わせください。
* ID プロバイダー にサインインした後、JWT を取得したら、安全な場所にファイルに保存し、環境変数 `WANDB_IDENTITY_TOKEN_FILE` に絶対ファイルパスを設定します。
* W&B SDK または CLI を使用して W&B プロジェクト にアクセスします。SDK または CLI は、JWT を自動的に検出し、JWT が正常に検証された後、W&B アクセストークンと交換します。W&B アクセストークンは、AI ワークフローを有効にするための関連する API にアクセスするために使用されます。つまり、runs、メトリクス、Artifacts などをログに記録します。アクセス トークンは、デフォルトで `~/.config/wandb/credentials.json` パスに保存されます。環境変数 `WANDB_CREDENTIALS_FILE` を指定することで、そのパスを変更できます。

{{% alert %}}
JWT は、API キー、パスワードなどの有効期間の長い認証情報の欠点に対処するための有効期間の短い認証情報です。ID プロバイダー で設定された JWT の有効期限に応じて、JWT を継続的に更新し、環境変数 `WANDB_IDENTITY_TOKEN_FILE` で参照されるファイルに保存されていることを確認する必要があります。

W&B アクセストークンにもデフォルトの有効期限があり、その後、SDK または CLI は JWT を使用して自動的に更新を試みます。ユーザー JWT もその時までに期限切れになっていて更新されていない場合、認証の失敗につながる可能性があります。可能であれば、W&B SDK または CLI を使用する AI ワークロードの一部として、JWT の取得および有効期限後の更新メカニズムを実装する必要があります。
{{% /alert %}}

### JWT の検証

JWT を W&B アクセストークンと交換して プロジェクト にアクセスするワークフローの一部として、JWT は次の検証を受けます。

* JWT 署名は、W&B 組織レベルで JWKS を使用して検証されます。これは最初の防御線であり、これが失敗した場合、JWKS または JWT の署名方法に問題があることを意味します。
* JWT の `iss` クレームは、組織レベルで設定された発行者 URL と同じである必要があります。
* JWT の `sub` クレームは、W&B 組織で設定されているユーザー のメールアドレスと同じである必要があります。
* JWT の `aud` クレームは、AI ワークフローの一部としてアクセスしている プロジェクト を含む W&B 組織の名前と同じである必要があります。[専用クラウド]({{< relref path="/guides/hosting/hosting-options/dedicated_cloud.md" lang="ja" >}}) または [自己管理]({{< relref path="/guides/hosting/hosting-options/self-managed.md" lang="ja" >}}) インスタンスの場合、インスタンスレベルの環境変数 `SKIP_AUDIENCE_VALIDATION` を `true` に設定して、オーディエンス クレームの検証をスキップするか、オーディエンスとして `wandb` を使用できます。
* JWT の `exp` クレームは、トークンが有効かどうか、期限切れで更新が必要かどうかを確認するためにチェックされます。

## 外部サービスアカウント

W&B は、有効期間の長い API キー を持つ組み込みのサービスアカウントを長年サポートしてきました。SDK および CLI の ID連携機能を使用すると、JWT を認証に使用できる外部サービスアカウントも導入できます。ただし、これらは組織レベルで設定されているのと同じ発行者によって発行されている場合に限ります。チーム管理者は、組み込みのサービスアカウントと同様に、チームのスコープ内で外部サービスアカウントを設定できます。

外部サービスアカウントを設定するには:

* チームの **Service Accounts** タブに移動します。
* `New service account` を押します。
* サービスアカウントの名前を入力し、`Authentication Method` として `Federated Identity` を選択し、`Subject` を入力して、`Create` を押します。

外部サービスアカウントの JWT の `sub` クレームは、チーム管理者がチームレベルの **Service Accounts** タブでサブジェクトとして構成したものと同じである必要があります。そのクレームは、[JWT の検証]({{< relref path="#jwt-validation" lang="ja" >}}) の一部として検証されます。`aud` クレームの要件は、人間の ユーザー JWT の要件と同様です。

[外部サービスアカウントの JWT を使用して W&B にアクセスする]({{< relref path="#using-the-jwt-to-access-wb" lang="ja" >}}) 場合、初期 JWT を生成し、継続的に更新するワークフローを自動化する方が通常は簡単です。外部サービスアカウントを使用してログに記録された runs を人間の ユーザー に帰属させたい場合は、組み込みのサービスアカウントの場合と同様に、AI ワークフローの環境変数 `WANDB_USERNAME` または `WANDB_USER_EMAIL` を構成できます。

{{% alert %}}
W&B は、柔軟性とシンプルさのバランスを取るために、さまざまなレベルのデータ機密性を持つ AI ワークロード全体で、組み込みおよび外部サービスアカウントを組み合わせて使用することをお勧めします。
{{% /alert %}}
