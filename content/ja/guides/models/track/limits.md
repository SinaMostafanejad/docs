---
title: Experiments limits and performance
description: これらの推奨範囲内でログを記録することで、W&B のページをより速く、より応答性の高い状態に保つことができます。
menu:
  default:
    identifier: ja-guides-models-track-limits
    parent: experiments
weight: 7
---

以下の推奨範囲内でログを記録することで、W&B のページをより高速かつ応答性の高い状態に保つことができます。

## 記録される メトリクス

`wandb.log` を使用して、実験 メトリクス を追跡します。ログに記録されると、これらの メトリクス はチャートを生成し、テーブルに表示されます。ログに記録するデータが多すぎると、アプリケーションの動作が遅くなる可能性があります。

### 個別の メトリクス 数

パフォーマンスを向上させるには、1 つの project 内の個別の メトリクス の総数を 10,000 未満に抑えてください。

```python
import wandb

wandb.log(
    {
        "a": 1,  # "a" は個別の メトリクス
        "b": {
            "c": "hello",  # "b.c" は個別の メトリクス
            "d": [1, 2, 3],  # "b.d" は個別の メトリクス
        },
    }
)
```

{{% alert %}}
W&B は、ネストされた値を自動的にフラット化します。つまり、辞書を渡すと、W&B はそれをドットで区切られた名前に変換します。 config の値の場合、W&B は名前に 3 つのドットをサポートします。 summary の値の場合、W&B は 4 つのドットをサポートします。
{{% /alert %}}

もし ワークスペース の動作が突然遅くなった場合は、最近の runs が意図せずに数千もの新しい メトリクス を記録していないか確認してください。（これは、1 つまたは 2 つの runs のみが表示されている数千ものプロットがあるセクションを見ることで、最も簡単に見つけることができます。）もし記録している場合は、それらの runs を削除し、目的の メトリクス で再作成することを検討してください。

### 値の幅

1 回のログ記録された値のサイズを 1 MB 未満に、1 回の `wandb.log` 呼び出しの合計サイズを 25 MB 未満に制限してください。この制限は、`wandb.Image`、`wandb.Audio` などの `wandb.Media` タイプには適用されません。

```python
# ❌ 推奨されません
wandb.log({"wide_key": range(10000000)})

# ❌ 推奨されません
with f as open("large_file.json", "r"):
    large_data = json.load(f)
    wandb.log(large_data)
```

幅の広い値は、幅の広い値を持つ メトリクス だけでなく、run 内のすべての メトリクス のプロットのロード時間に影響を与える可能性があります。

{{% alert %}}
データは、推奨量よりも幅の広い値を記録した場合でも保存および追跡されます。ただし、プロットのロードが遅くなる可能性があります。
{{% /alert %}}

### メトリクス の頻度

ログに記録する メトリクス に適切なログ記録頻度を選択してください。一般的な経験則として、メトリクス の幅が広いほど、ログに記録する頻度を少なくする必要があります。W&B は以下を推奨します。

- スカラー: メトリクス ごとに \<100,000 ログポイント
- メディア: メトリクス ごとに \<50,000 ログポイント
- ヒストグラム: メトリクス ごとに \<10,000 ログポイント

```python
# 100 万ステップのトレーニング ループ
for step in range(1000000):
    # ❌ 推奨されません
    wandb.log(
        {
            "scalar": step,  # 100,000 スカラー
            "media": wandb.Image(...),  # 100,000 画像
            "histogram": wandb.Histogram(...),  # 100,000 ヒストグラム
        }
    )

    # ✅ 推奨
    if step % 1000 == 0:
        wandb.log(
            {
                "histogram": wandb.Histogram(...),  # 10,000 ヒストグラム
            },
            commit=False,
        )
    if step % 200 == 0:
        wandb.log(
            {
                "media": wandb.Image(...),  # 50,000 画像
            },
            commit=False,
        )
    if step % 100 == 0:
        wandb.log(
            {
                "scalar": step,  # 100,000 スカラー
            },
            commit=True,
        )  # バッチ処理されたステップごとの メトリクス をまとめてコミットします
```

{{% alert %}}
ガイドラインを超過した場合でも、W&B はログに記録されたデータを受け入れ続けますが、ページのロードが遅くなる可能性があります。
{{% /alert %}}

### Config サイズ

run config の合計サイズを 10 MB 未満に制限してください。大きな値を記録すると、project の ワークスペース と runs テーブルの操作が遅くなる可能性があります。

```python
# ✅ 推奨
wandb.init(
    config={
        "lr": 0.1,
        "batch_size": 32,
        "epochs": 4,
    }
)

# ❌ 推奨されません
wandb.init(
    config={
        "steps": range(10000000),
    }
)

# ❌ 推奨されません
with f as open("large_config.json", "r"):
    large_config = json.load(f)
    wandb.init(config=large_config)
```

### Run 数

ロード時間を短縮するには、1 つの project 内の runs の合計数を 10,000 未満に抑えてください。run 数が多いと、project の ワークスペース と runs テーブルの操作が遅くなる可能性があります。特に、グループ化が有効になっている場合や、runs に多数の個別の メトリクス がある場合は遅くなる可能性があります。

あなたまたはあなたの team が頻繁に同じ runs のセット (たとえば、最近の runs) にアクセスしている場合は、[_他の_ runs を一括で移動する]({{< relref path="/guides/models/track/runs/manage-runs.md" lang="ja" >}}) ことを検討して、アーカイブとして使用される新しい project に移動し、作業 project にはより少ない runs のセットを残します。

### セクション数

ワークスペース に数百のセクションがあると、パフォーマンスが低下する可能性があります。メトリクス の高レベルのグループ化に基づいてセクションを作成し、メトリクス ごとに 1 つのセクションというアンチパターンを避けることを検討してください。

セクションが多すぎてパフォーマンスが遅い場合は、接尾辞ではなくプレフィックスでセクションを作成する ワークスペース の設定を検討してください。これにより、セクションの数が減り、パフォーマンスが向上する可能性があります。

{{< img src="/images/track/section_prefix_toggle.gif" alt="セクションの作成の切り替え" >}}

### ファイル数

1 回の run でアップロードされるファイルの合計数を 1,000 未満に抑えてください。多数のファイルをログに記録する必要がある場合は、W&B Artifacts を使用できます。1 回の run で 1,000 を超えるファイルがあると、run ページの動作が遅くなる可能性があります。

## Python スクリプトのパフォーマンス

Python スクリプトのパフォーマンスが低下する原因はいくつかあります。

1. データのサイズが大きすぎる。データのサイズが大きいと、トレーニング ループに >1 ms のオーバーヘッドが発生する可能性があります。
2. ネットワークの速度と W&B バックエンドの構成方法
3. `wandb.log` を 1 秒に数回以上呼び出す。これは、`wandb.log` が呼び出されるたびに、トレーニング ループに小さな遅延が追加されるためです。

{{% alert %}}
頻繁なログ記録によってトレーニング run の速度が低下していませんか? ログ記録戦略を変更してパフォーマンスを向上させる方法については、[この Colab](http://wandb.me/log-hf-colab) を参照してください。
{{% /alert %}}

W&B は、レート制限を超える制限は一切主張しません。W&B Python SDK は、制限を超えるリクエストに対して、指数関数的な「バックオフ」および「再試行」リクエストを自動的に完了します。W&B Python SDK は、コマンドラインで「ネットワーク障害」で応答します。無償アカウントの場合、W&B は、使用量が妥当な閾値を超える極端な場合に連絡する場合があります。

## レート制限

W&B SaaS Cloud API は、システムの整合性を維持し、可用性を確保するために、レート制限を実装しています。この対策により、共有 インフラストラクチャー で利用可能なリソースを 1 人の ユーザー が独占することを防ぎ、すべての ユーザー がサービスにアクセスできるようにします。さまざまな理由で、より低いレート制限が発生する可能性があります。

{{% alert %}}
レート制限は変更される可能性があります。
{{% /alert %}}

### レート制限 HTTP ヘッダー

前のテーブルでは、レート制限 HTTP ヘッダーについて説明しています。

| ヘッダー名          | 説明                                                                                |
| ------------------- | ----------------------------------------------------------------------------------- |
| RateLimit-Limit     | 時間枠あたりのクォータの量。0 ～ 1000 の範囲でスケーリングされます                            |
| RateLimit-Remaining | 現在のレート制限ウィンドウのクォータの量。0 ～ 1000 の範囲でスケーリングされます                       |
| RateLimit-Reset     | 現在のクォータがリセットされるまでの秒数                                                         |

### メトリクス ログ記録 API のレート制限

スクリプト内の `wandb.log` 呼び出しは、メトリクス ログ記録 API を利用して、トレーニングデータを W&B に記録します。この API は、オンラインまたは[オフライン同期]({{< relref path="/ref/cli/wandb-sync.md" lang="ja" >}})のいずれかを介して利用されます。どちらの場合も、ローリング時間枠でレート制限クォータ制限が課せられます。これには、合計リクエスト サイズとリクエスト レートの制限が含まれており、後者は時間内のリクエスト数を指します。

W&B は、W&B project ごとにレート制限を適用します。したがって、team に 3 つの project がある場合、各 project には独自のレート制限クォータがあります。[Teams と Enterprise プラン](https://wandb.ai/site/pricing)の ユーザー は、無料プランの ユーザー よりも高いレート制限があります。

メトリクス ログ記録 API の使用中にレート制限に達すると、標準出力にエラーを示す関連メッセージが表示されます。

### メトリクス ログ記録 API のレート制限を下回るための推奨事項

レート制限を超えると、レート制限がリセットされるまで `run.finish()` が遅れる可能性があります。これを回避するには、次の戦略を検討してください。

- W&B Python SDK のバージョンを更新します。最新バージョンの W&B Python SDK を使用していることを確認してください。W&B Python SDK は定期的に更新されており、リクエストを正常に再試行し、クォータの使用量を最適化するための拡張メカニズムが含まれています。
- メトリクス ログ記録の頻度を減らします。
  クォータを節約するために、メトリクス をログに記録する頻度を最小限に抑えます。たとえば、エポックごとに メトリクス をログに記録する代わりに、5 エポックごとに メトリクス をログに記録するようにコードを変更できます。

```python
if epoch % 5 == 0:  # 5 エポックごとに メトリクス をログに記録します
    wandb.log({"acc": accuracy, "loss": loss})
```

- 手動データ同期: レートが制限されている場合、W&B は run データをローカルに保存します。コマンド `wandb sync <run-file-path>` を使用して、データを手動で同期できます。詳細については、[`wandb sync`]({{< relref path="/ref/cli/wandb-sync.md" lang="ja" >}}) リファレンスを参照してください。

### GraphQL API のレート制限

W&B Models UI と SDK の[パブリック API](https://docs.wandb.ai/ref/python/public-api/api)は、GraphQL リクエストをサーバーに送信して、データのクエリと変更を行います。SaaS Cloud のすべての GraphQL リクエストについて、W&B は承認されていないリクエストについては IP アドレスごとに、承認されたリクエストについては ユーザー ごとにレート制限を適用します。制限は、固定時間枠内のリクエスト レート (1 秒あたりのリクエスト数) に基づいており、料金プランによってデフォルトの制限が決まります。project パス (たとえば、レポート、runs、Artifacts) を指定する関連 SDK リクエストの場合、W&B はデータベース クエリ時間で測定された project ごとにレート制限を適用します。

[Teams と Enterprise プラン](https://wandb.ai/site/pricing)の ユーザー は、無料プランの ユーザー よりも高いレート制限を受け取ります。W&B Models SDK のパブリック API の使用中にレート制限に達すると、標準出力にエラーを示す関連メッセージが表示されます。

### GraphQL API のレート制限を下回るための推奨事項

W&B Models SDK の[パブリック API](https://docs.wandb.ai/ref/python/public-api/api)を使用して大量のデータを取得する場合は、リクエストの間隔を少なくとも 1 秒空けることを検討してください。`429` ステータス コードを受信した場合、または応答ヘッダーに `RateLimit-Remaining=0` が表示された場合は、再試行する前に `RateLimit-Reset` で指定された秒数待機してください。

## ブラウザに関する考慮事項

W&B アプリはメモリを大量に消費する可能性があり、Chrome で最高のパフォーマンスを発揮します。コンピューターのメモリによっては、W&B が 3 つ以上のタブで同時にアクティブになっていると、パフォーマンスが低下する可能性があります。予期せぬパフォーマンスの低下が発生した場合は、他のタブまたはアプリケーションを閉じることを検討してください。

## W&B へのパフォーマンス問題の報告

W&B はパフォーマンスを重視しており、遅延のすべてのレポートを調査しています。調査を迅速化するために、ロード時間の遅延を報告する際は、主要な メトリクス とパフォーマンス イベントをキャプチャする W&B の組み込みパフォーマンス ロガーを起動することを検討してください。URL に &PERF_LOGGING を追加し、コンソールの出力を共有します。

{{< img src="/images/track/adding_perf_logging.gif" alt="PERF_LOGGING の追加" >}}
